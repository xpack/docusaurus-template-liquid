{/* DO NOT EDIT! */}
{/* Automatically generated from docusaurus-template-liquid/templates/docusaurus. */}

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

import CodeBlock from '@theme/CodeBlock';

import customField from '@site/src/libs/customField';
import isXpackSubversionDouble from '@site/src/libs/isXpackSubversionDouble';
import dateYYYYMMDD from '@site/src/libs/dateYYYYMMDD';

import ReleaseSchedule from '../../_shared/_release-schedule.mdx';
import GitHubActionsDurations from '../../_shared/_github-actions-durations.mdx';
import {developmentDurations} from '../../_shared/_development-durations.mdx';

import PlatformNativeBuild from '../_common/_platform-native-build.mdx';
import PlatformDockerBuild from '../_common/_platform-docker-build.mdx';
import GenerateTopCommons from '../_common/_generate-top-commons.mdx';

import MoreRepos from '../_project/_more-repos.mdx';
import CheckUpstreamRelease from '../_project/_check-upstream-release.mdx';
import UpdateVersionSpecific from '../_project/_update-version-specific.mdx';
import MoreTests from '../_project/_more-tests.mdx';
import ShareCustom from '../_project/_share-custom.mdx';
import FirstDevelopmentRun from '../_project/_first-development-run.mdx';
import FirstProductionRun from '../_project/_first-production-run.mdx';
import Patches from '../_project/_patches.mdx';

{/* ------------------------------------------------------------------------ */}

## Prerequisites

{%- assign platforms_array = platforms | split: "," %}

{%- assign isMacOS = false %}
{%- assign isLinux = false %}
{%- assign isWindows = false %}

{%- for platform in platforms_array %}
{%- if platform == "darwin-x64" or platform == "darwin-arm64" %}{% assign isMacOS = true %}{% endif %}
{%- if platform == "linux-x64" or platform == "linux-arm64" or platform == "linux-arm" %}{% assign isLinux = true %}{% endif %}
{%- if platform == "win32-x64" %}{% assign isWindows = true %}{% endif %}
{%- endfor %}

{% if isLinux and isMacOS %}The build scripts run on GNU/Linux and macOS.{% else %}{% if isLinux %}The build scripts run on GNU/Linux.{% endif %}{% if isMacOS %}The build scripts run on macOS.{% endif %}{% endif %}
{% if isWindows %}The Windows binaries are
compiled on x64 GNU/Linux, using [mingw-w64](https://mingw-w64.org).{% endif %}

For details on installing the prerequisites, please read the
[Build Prerequisites](https://xpack-dev-tools.github.io/docs/developer/install/prerequisites/)
page.

## Get project sources

The project is hosted on GitHub:

- https://github.com/{{githubProjectOrganization}}/{{githubProjectName}}.git

To clone the **stable** branch (`xpack`), run the following commands in a
terminal (on Windows use the _Git Bash_ console):

```sh
rm -rf ~/Work/{{githubProjectOrganization}}/{{githubProjectName}}.git && \
git clone https://github.com/{{githubProjectOrganization}}/{{githubProjectName}}.git \
  ~/Work/{{githubProjectOrganization}}/{{githubProjectName}}.git
```

For **development** purposes, clone the `xpack-development` branch:

```sh
rm -rf ~/Work/{{githubProjectOrganization}}/{{githubProjectName}}.git && \
mkdir -p ~/Work/{{githubProjectOrganization}} && \
git clone \
  --branch xpack-development \
  https://github.com/{{githubProjectOrganization}}/{{githubProjectName}}.git \
  ~/Work/{{githubProjectOrganization}}/{{githubProjectName}}.git
```

Or, if the repo was already cloned:

```sh
git -C ~/Work/{{githubProjectOrganization}}/{{githubProjectName}}.git pull
```

## Get the writable helper sources

The project has a dependency to a common **helper**, that is
normally installed as a read-only dependency; for **development
purposes**, to be able to make changes to the scripts located inside the helper,
clone the `xpack-development` branch and link it to
the user global xPacks store:

```sh
rm -rf ~/Work/{{githubProjectOrganization}}/xbb-helper-xpack.git && \
mkdir -p ~/Work/{{githubProjectOrganization}} && \
git clone \
  --branch xpack-development \
  https://github.com/{{githubProjectOrganization}}/xbb-helper-xpack.git \
  ~/Work/{{githubProjectOrganization}}/xbb-helper-xpack.git && \
xpm link -C ~/Work/{{githubProjectOrganization}}/xbb-helper-xpack.git
```

Or, if the repo was already cloned:

```sh
git -C ~/Work/{{githubProjectOrganization}}/xbb-helper-xpack.git pull
xpm link -C ~/Work/{{githubProjectOrganization}}/xbb-helper-xpack.git
```

<MoreRepos/>

<ReleaseSchedule/>

## Prepare the new releases

Before starting the build, perform some checks and tweaks.

### Download the build scripts

The build scripts are available in the `build-assets/scripts` folder of the
[`{{githubProjectOrganization}}/{{githubProjectName}}`](https://github.com/{{githubProjectOrganization}}/{{githubProjectName}}/)
Git repo.

To download them on a new machine, clone the `xpack-development` branch,
as seen above.

### Check Git

In the `{{githubProjectOrganization}}/{{githubProjectName}}` Git repo:

- switch to the `xpack-development` branch
- pull new changes
- if necessary, **merge** the `xpack` branch
- if necessary, **merge** the `website` branch

:::caution

This is really important, otherwise the next steps will build again the previous release!

:::

The `xpack` branch should be unchanged since the previous release
and will be updated when the new release is out.

### Update helper & other dependencies

Check the latest versions at https://github.com/{{githubProjectOrganization}}/ and
update the dependencies in `build-assets/package.json`.

<CheckUpstreamRelease/>

### Increase the version and update it in the top `package.json`

- determine the version (like <code>{{releaseVersion}}</code>)
- update the version in top `package.json`
- use the new version, suffixed by `.pre`,
like <code>{{releaseVersion}}.pre</code>.

### Increase the version and update VERSION

Determine the version (like <code>{{releaseSemver}}-{{releaseSubversion}}</code>)
and update the `build-assets/scripts/VERSION` file; the format
is <code>{{releaseSemver}}-{{releaseSubversion}}</code>.
{isXpackSubversionDouble() ?
'The fourth & fifth numbers are the xPack release number of this version. A sixth' :
'The fourth number is the xPack release number of this version. A fifth'} number will be added to the version in `package.json` when the package is published to the `npm` server.

### Update the `websiteConfig` in `website/package.json` (if necessary)

- update the release specific properties (if any)

<GenerateTopCommons />

### Update the website commons

Run the **generate-website-commons** npm script from `website/package.json`.

### Commit the website changes

- **stage** `website` and top `README.md`
- **commit** with the message _**website: re-generate commons**_

### Start the local web server

Execute the npm script **clean** then **start** in the website sub-project,
or run the following in a terminal:

```sh
(cd ~/Work/{{githubProjectOrganization}}/xbb-helper-xpack.git/website; npm run clean; npm run start)
```

Navigate to the **Maintainer Info** page,
the **[Update the version specific code](http://localhost:3000/{{githubProjectName}}/docs/maintainer/#update-the-version-specific-code)** section.

<UpdateVersionSpecific/>

### Fix possible open issues

Check GitHub issues and pull requests:

- https://github.com/{{githubProjectOrganization}}/{{githubProjectName}}/issues
- https://github.com/{{githubProjectOrganization}}/{{githubProjectName}}/pulls

and fix them; assign them to a milestone (like <code>{{releaseSemver}}-{{releaseSubversion}}</code>).

### Update `CHANGELOG.md`

- open the `CHANGELOG.md` file
- check if all previous fixed issues are in
- check the latest commits `xpm run git-log`; if necessary, copy/paste lines,
  group by dates and edit them using the below regular expressions
- to turn the dates into headings, change from:
  ```txt


  ([0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]) [*]
  ```
  to:
  ```txt


  ## $1

  *
  ```
- to remove the rest of the dates, change from:
  ```txt
  ^[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9] [*]
  ```
  to:
  ```txt
  *
  ```
- add a new entry like _**\* v{{releaseSemver}}-{{releaseSubversion}} prepared**_
- **commit** with the message _**prepare v{{releaseSemver}}-{{releaseSubversion}}**_


### Push the changes to the `xpack-development` branch

Be sure that the latest commit that updates `VERSION` is pushed
to the `xpack-development` branch!

:::caution

This is really important, otherwise the next steps
will build again the previous release!

:::

## Run the development builds

{%- assign platforms_array = platforms | split: "," %}
{%- assign names_array = "" | split: "" %}

{%- for platform in platforms_array %}
{%- if platform == "darwin-x64" %}{% assign names_array = names_array | concat: "x64 macOS" %}{% endif %}
{%- if platform == "darwin-arm64" %}{% assign names_array = names_array | concat: "arm64 macOS" %}{% endif %}
{%- if platform == "win32-x64" or platform == "linux-x64" %}{% assign names_array = names_array | concat: "x64 GNU/Linux" %}{% endif %}
{%- if platform == "linux-arm64" %}{% assign names_array = names_array | concat: "arm64 GNU/Linux" %}{% endif %}
{%- if platform == "linux-arm" %}{% assign names_array = names_array | concat: "arm GNU/Linux" %}{% endif %}
{%- endfor %}

{%- assign names_array = names_array | uniq %}

{% if names_array.size > 1 %}The builds currently run on {{names_array.size}} dedicated machines ({{ names_array | join: ", " }}){% else %}The build currently runs on the {{ names_array | join: "" }} machine{% endif %}.

Before the real build, run {% if names_array.size > 1 %}test/development builds on all platforms{% else %}a test/development build{% endif %}.

<FirstDevelopmentRun/>

### Visual Studio Code extension

All actions are defined as **xpm/xPack actions** and can be conveniently
triggered via the VS Code graphical interface, using the
[xPack C/C++ Managed Build Tools extension](https://marketplace.visualstudio.com/items?itemName=ilg-vscode.xpack).

<Patches/>

### Restart the docker daemons

If, for any reasons, the docker builds need to be canceled, it is very
likely that some processes will continue to run in the background.

To completely terminate them, and ensure that docker runs
from a clean slate, restart the docker daemons on all GNU/Linux
machines:

```sh
sudo systemctl restart docker
```

### Check if both projects are pushed

Check if both the **current project** and the **helper** are
on the `xpack-development` branch and the latest
commits are pushed to GitHub.

:::caution

This is particularly crucial for large projects; otherwise,
the build may proceed with the previous version.

:::

{%- assign platforms_array = platforms | split: "," %}
{%- assign names_array = "" | split: "" %}

{%- for platform in platforms_array %}{% if platform == "darwin-x64" %}{% assign names_array = names_array | concat: platform %}{% endif %}{% endfor %}
{%- for platform in platforms_array %}{% if platform == "darwin-arm64" %}{% assign names_array = names_array | concat: platform %}{% endif %}{% endfor %}
{%- for platform in platforms_array %}{% if platform == "linux-x64" %}{% assign names_array = names_array | concat: platform %}{% endif %}{% endfor %}
{%- for platform in platforms_array %}{% if platform == "win32-x64" %}{% assign names_array = names_array | concat: platform %}{% endif %}{% endfor %}
{%- for platform in platforms_array %}{% if platform == "linux-arm64" %}{% assign names_array = names_array | concat: platform %}{% endif %}{% endfor %}
{%- for platform in platforms_array %}{% if platform == "linux-arm" %}{% assign names_array = names_array | concat: platform %}{% endif %}{% endfor %}

{%- for name in names_array %}

{%- if name == "darwin-x64" %}

### Build the x64 macOS binaries

For x64 macOS, first run the build on the development machine
(`wksi`, a recent macOS):

```sh
export XBB_ENVIRONMENT_SKIP_CHECKS="y"
```

```sh
rm -f ~/Work/{{githubProjectOrganization}}/{{githubProjectName}}.git/build-assets/package-lock.json
git -C ~/Work/{{githubProjectOrganization}}/{{githubProjectName}}.git pull

xpm run install -C ~/Work/{{githubProjectOrganization}}/{{githubProjectName}}.git/build-assets

git -C ~/Work/{{githubProjectOrganization}}/xbb-helper-xpack.git pull
xpm link -C ~/Work/{{githubProjectOrganization}}/xbb-helper-xpack.git

xpm run link-deps -C ~/Work/{{githubProjectOrganization}}/{{githubProjectName}}.git/build-assets

xpm run deep-clean --config darwin-x64  -C ~/Work/{{githubProjectOrganization}}/{{githubProjectName}}.git/build-assets && \
xpm install --config darwin-x64 -C ~/Work/{{githubProjectOrganization}}/{{githubProjectName}}.git/build-assets && \
xpm run build-development --config darwin-x64 -C ~/Work/{{githubProjectOrganization}}/{{githubProjectName}}.git/build-assets
```

For a debug build:

```sh
xpm run build-development-debug --config darwin-x64 -C ~/Work/{{githubProjectOrganization}}/{{githubProjectName}}.git/build-assets
```

The build takes {developmentDurations["work"]} to complete.

When functional, **push** the `xpack-development` branch to GitHub.

Run the native build on the production machine
(`xbbmi`, an older macOS);
start a VS Code remote session, or connect with a terminal:

```sh
caffeinate ssh xbbmi
```

<PlatformNativeBuild platform="darwin-x64"/>

{%- endif %}

{%- if name == "darwin-arm64" %}

### Build the arm64 macOS binaries

Run the native build on the production machine
(`xbbma`, an older macOS);
start a VS Code remote session, or connect with a terminal:

```sh
caffeinate ssh xbbma
```

<PlatformNativeBuild platform="darwin-arm64"/>

{%- endif %}

{%- if name == "linux-x64" %}

### Build the x64 GNU/Linux binaries

Run the docker build on the production machine (`xbbli`);
start a VS Code remote session, or connect with a terminal:

```sh
caffeinate ssh xbbli
```

<PlatformDockerBuild platform="linux-x64"/>

{%- endif %}

{%- if name == "win32-x64" %}

### Build the x64 Windows binaries

Run the docker build on the production machine (`xbbli`);
start a VS Code remote session, or connect with a terminal:

```sh
caffeinate ssh xbbli
```

<PlatformDockerBuild platform="win32-x64"/>

{%- endif %}

{%- if name == "linux-arm64" %}

### Build the arm64 GNU/Linux binaries

Run the docker build on the production machine (`ampere`);
start a VS Code remote session, or connect with a terminal:

```sh
caffeinate ssh ampere
```

<PlatformDockerBuild platform="linux-arm64"/>

{%- endif %}

{%- if name == "linux-arm" %}

### Build the arm GNU/Linux (32-bit) binaries

Run the docker build on the production machine (`xbbla32`);
start a VS Code remote session, or connect with a terminal:

```sh
caffeinate ssh xbbla32
```

<PlatformDockerBuild platform="linux-arm"/>

{%- endif %}

{%- endfor %}

### Update the durations of the development builds

In `website/docs/_shared/_development-durations.mdx`, update
the durations of the builds.

Commit with the message _**website: update development durations**_.

### Update the trees in the Install Guide page

{%- assign platforms_array = platforms | split: "," %}

{%- assign isMacOS = false %}
{%- assign isLinux = false %}
{%- assign isWindows = false %}

{%- for platform in platforms_array %}
{%- if platform == "darwin-x64" or platform == "darwin-arm64" %}{% assign isMacOS = true %}{% endif %}
{%- if platform == "linux-x64" or platform == "linux-arm64" or platform == "linux-arm" %}{% assign isLinux = true %}{% endif %}
{%- if platform == "win32-x64" %}{% assign isWindows = true %}{% endif %}
{%- endfor %}

Copy the trees displayed at the end of the test builds and paste to
**Folder hierarchy** section in the web file:

{% if isLinux -%}
- `website/docs/_shared/_folders-hierarchies-linux.mdx`
{%- endif %}
{% if isMacOS -%}
- `website/docs/_shared/_folders-hierarchies-macos.mdx`
{%- endif %}
{% if isWindows -%}
- `website/docs/_shared/_folders-hierarchies-windows.mdx`
{%- endif %}

If present, replace the actual version
(like **{{upstreamVersion}}**) with the following expression:

```txt
${customField('upstreamVersion')}
```

{% if isMacOS -%}
:::tip

macOS does not have a `tree` command; either compile it from
[sources](https://github.com/Old-Man-Programmer/tree), or install it
via HomeBrew, and make a link to `/usr/local/bin`.

:::
{% endif %}

Commit with the message _**website: update folder hierarchies**_.

### Update the list of links in top package.json

{%- assign platforms_array = platforms | split: "," %}
{%- assign names_array = "" | split: "" %}

{%- for platform in platforms_array %}
{%- if platform == "win32-x64" %}{% assign names_array = names_array | concat: "Windows" %}{% endif %}
{%- if platform == "darwin-x64" or platform == "darwin-arm64" %}{% assign names_array = names_array | concat: "macOS" %}{% endif %}
{%- if platform == "linux-x64" or platform == "linux-arm64" or platform == "linux-arm" %}{% assign names_array = names_array | concat: "GNU/Linux" %}{% endif %}
{%- endfor %}

{%- assign names_array = names_array | uniq %}

Copy/paste the full list of links displayed at the end of the build, in
sequence, {% if names_array.size > 1 %}for each platform ({{ names_array | join: ", " }}),{% endif %}
and check the
differences compared to the repository.

Commit if necessary with the message _**package.json: update executables links**_.

### How to build a debug version

In some cases it is necessary to run a debug session with the binaries.

For these cases, the build script accepts the `--debug` options.

There are also xpm actions that use this option (**build-development-debug**
and **docker-build-development-debug**).

### Files cache

The XBB build scripts use a local cache such that files are downloaded only
during the first run, later runs being able to use the cached files.

However, occasionally some servers may not be available, and the builds
may fail.

The workaround is to manually download the files from alternate
locations (like
https://github.com/xpack-dev-tools/files-cache/tree/master/libs),
place them in the XBB cache (`Work/cache`) and restart the build.

## Run the production builds

The automation is provided by GitHub Actions and three self-hosted runners.

### Start the self-hosted runners

If the runners expired (more than 2 weeks since last use), run the
`github-runner-configure.sh` script to reconfigure them. This scripts
is available in the `xbb-helper` and
requires `GITHUB_API_XPACK_DEV_TOOLS_RUNNERS_TOKEN` to be present.

{%- assign platforms_array = platforms | split: "," %}

{%- assign dual_runner = false %}
{%- assign dual_runners_array = "" | split: ""  %}
{%- assign single_runner = false %}
{%- assign isMacOS = false %}

{%- assign names_array = "" | split: "" %}

{%- for platform in platforms_array %}
{%- if platform == "darwin-x64" %}{% assign names_array = names_array | concat: "xbbmi" %}{% assign single_runner = true %}{% assign isMacOS = true %}{% endif %}
{%- if platform == "darwin-arm64" %}{% assign names_array = names_array | concat: "xbbma" %}{% assign single_runner = true %}{% assign isMacOS = true %}{% endif %}
{%- if platform == "linux-x64" or platform == "win32-x64" %}{% assign names_array = names_array | concat: "xbbli" %}{% assign dual_runner = true %}{% assign dual_runners_array = dual_runners_array | concat: "xbbli" %}{% endif %}
{%- if platform == "linux-arm64" %}{% assign names_array = names_array | concat: "ampere" %}{% assign dual_runner = true %}{% assign dual_runners_array = dual_runners_array | concat: "ampere" %}{% endif %}
{%- if platform == "linux-arm" %}{% assign names_array = names_array | concat: "xbbla32" %}{% assign single_runner = true %}{% endif %}
{%- endfor %}

{%- assign names_array = names_array | uniq %}
{%- assign dual_runners_array = dual_runners_array | uniq %}

- on the development machine (`wksi`) open
{% if names_array.size > 1 %}ssh sessions to the build machines (`{{ names_array | join: "`, `"}}`){% else %}a ssh session to the build machine `{{ names_array | join: "" }}`{% endif %}:

```sh
{% for name in names_array -%}
caffeinate ssh {{name}}
{% endfor -%}
{% comment %}{% endcomment %}```

Create a `screen` session, to provide a persistent standard output for
the runners:

```sh
screen -S ga
```

To quit it, use `# Ctrl-a Ctrl-d`.

{%- if dual_runner %}

For {% if dual_runners_array.size > 1 %}`{{dual_runners_array | join: "` & `"}}`, which have{% else %}`{{dual_runners_array}}`, which has{% endif %} more memory, start two runners:

```sh
~/actions-runners/{{githubProjectOrganization}}/1/run.sh &
~/actions-runners/{{githubProjectOrganization}}/2/run.sh &
```

{%- endif %}

{%- if single_runner %}

{%- if isMacOS %}

For the macOS x64 runners, be sure the deployment target is defined:

```sh
unset WORK_FOLDER_PATH
export XBB_ENVIRONMENT_MACOSX_DEPLOYMENT_TARGET="11.0"
~/actions-runners/{{githubProjectOrganization}}/run.sh &
```

```sh
unset WORK_FOLDER_PATH
export XBB_ENVIRONMENT_MACOSX_DEPLOYMENT_TARGET="11.0"
~/actions-runners/{{githubProjectOrganization}}/run.sh &
```

{%- endif %}

On all other machines start the runner with:

```sh
~/actions-runners/{{githubProjectOrganization}}/run.sh &
```

{%- endif %}

To check the status of the runners locally:

```sh
ps -a | grep 'Runner.Listener'
```

To kill them:

```sh
killall Runner.Listener
```

### Check the status of the runners

The status of all self-hosted runners is available at the [GitHub Runners](https://github.com/organizations/{{githubProjectOrganization}}/settings/actions/runners) page.

### Publish the helper

Publish a new release of the helper on **npmjs**.

### In the npm packages helper, update the dependency to the new helper

In `templates/_xpack-dev-tools/build-assets/package-merge-liquid.json`, update the reference
to `"@xpack-dev-tools/xbb-helper":`.

<GenerateTopCommons />

### Check for disk space

Check if the build machines have enough free space and eventually
do some cleanups:

```sh
xpm run check-space -C ~/Work/{{githubProjectOrganization}}/{{githubProjectName}}.git/build-assets
```

This is equivalent to running a `df` command.

{%- assign platforms_array = platforms | split: "," %}

{%- assign isMacOS = false %}
{%- assign isLinux = false %}

{%- for platform in platforms_array %}
{%- if platform == "darwin-x64" or platform == "darwin-arm64" %}{% assign isMacOS = true %}{% endif %}
{%- if platform == "linux-x64" or platform == "linux-arm64" or platform == "linux-arm" or platform == "win32-x64" %}{% assign isLinux = true %}{% endif %}
{%- endfor %}

<Tabs groupId="operating-systems">

{%- if isMacOS %}

<TabItem value="macos" label="macOS">

```
df -gH /
```

</TabItem>

{%- endif %}

{%- if isLinux %}

<TabItem value="linux" label="GNU/Linux">

```sh
df -BG -H /
```

</TabItem>

{%- endif %}

</Tabs>

To free the space used by all previous builds of all `{{githubProjectOrganization}}` packages:

```sh
xpm run clear-all-projects-builds -C ~/Work/{{githubProjectOrganization}}/{{githubProjectName}}.git/build-assets
```

This is equivalent to running a wide `rm` to remove the `build` folders:

```sh
rm -rf ~/Work/{{githubProjectOrganization}}/*/build-assets/build
```

### Commit and push

- **push** the `xpack-development` branch to GitHub

:::caution

This is particularly crucial for large projects; otherwise,
the build may proceed with the previous version.

:::

### Check if the helper is pushed and published

The helper `xpack` branch must be updated and the npm package published.

<FirstProductionRun/>

### Manually trigger the build GitHub Actions

To trigger the GitHub Actions builds, use the xpm actions:

{%- assign platforms_array = platforms | split: "," %}
{%- assign names_array = "" | split: "" %}

{%- for platform in platforms_array %}{% if platform == "darwin-x64" %}{% assign names_array = names_array | concat: platform %}{% endif %}{% endfor %}
{%- for platform in platforms_array %}{% if platform == "darwin-arm64" %}{% assign names_array = names_array | concat: platform %}{% endif %}{% endfor %}
{%- for platform in platforms_array %}{% if platform == "linux-x64" %}{% assign names_array = names_array | concat: platform %}{% endif %}{% endfor %}
{%- for platform in platforms_array %}{% if platform == "win32-x64" %}{% assign names_array = names_array | concat: platform %}{% endif %}{% endfor %}
{%- for platform in platforms_array %}{% if platform == "linux-arm64" %}{% assign names_array = names_array | concat: platform %}{% endif %}{% endfor %}
{%- for platform in platforms_array %}{% if platform == "linux-arm" %}{% assign names_array = names_array | concat: platform %}{% endif %}{% endfor %}

{% for name in names_array -%}
- **trigger-workflow-build-{{name}}**
{% endfor -%}
{% comment %}{% endcomment %}

```sh
{% for name in names_array -%}
xpm run trigger-workflow-build-{{name}} -C ~/Work/{{githubProjectOrganization}}/{{githubProjectName}}.git/build-assets
{% endfor -%}
{% comment %}{% endcomment %}```

The scripts behind these actions require the `GITHUB_API_DISPATCH_TOKEN`
variable to be present
in the environment, and the organization `PUBLISH_TOKEN` to be visible in the
Settings → Action →
[Secrets](https://github.com/{{githubProjectOrganization}}/{{githubProjectName}}/settings/secrets/actions)
page.

These commands use the `xpack-development` branch of this repo.

### Durations & resulting binaries

<GitHubActionsDurations/>

The workflow results and logs are available from the
[GitHub Actions](https://github.com/{{githubProjectOrganization}}/{{githubProjectName}}/actions) page.

Update the values in `website/docs/_shared/_github-actions-durations.mdx`
with those shown by GitHub Actions.

Commit with the message _**website: update actions durations**_.

The resulting binaries are available for testing from
[pre-releases/test](https://github.com/xpack-dev-tools/pre-releases/releases/tag/test/).

## Run the tests

### Automated tests

The automation is provided by GitHub Actions.

{%- assign platforms_array = platforms | split: "," %}

{%- assign isMacOSX64 = false %}
{%- assign isLinuxX64 = false %}
{%- assign isLinuxArm = false %}

{%- for platform in platforms_array %}
{%- if platform == "darwin-x64" %}{% assign isMacOSX64 = true %}{% endif %}
{%- if platform == "linux-x64" %}{% assign isLinuxX64 = true %}{% endif %}
{%- if platform == "linux-arm64" or platform == "linux-arm" %}{% assign isLinuxArm = true %}{% endif %}
{%- endfor %}

To trigger the GitHub Actions tests, run the xpm actions:

<ul>
<li><b>trigger-workflow-test-prime</b></li>
{%- if isLinuxX64 %}
<li><b>trigger-workflow-test-docker-linux-x64</b></li>
{%- endif %}
{%- if isLinuxArm %}
<li><b>trigger-workflow-test-docker-linux-arm</b></li>
{%- endif %}
</ul>

```sh
xpm run trigger-workflow-test-prime -C ~/Work/{{githubProjectOrganization}}/{{githubProjectName}}.git/build-assets
{%- if isLinuxX64 %}
xpm run trigger-workflow-test-docker-linux-x64 -C ~/Work/{{githubProjectOrganization}}/{{githubProjectName}}.git/build-assets
{%- endif %}
{%- if isLinuxArm %}
xpm run trigger-workflow-test-docker-linux-arm -C ~/Work/{{githubProjectOrganization}}/{{githubProjectName}}.git/build-assets
{%- endif %}
```

The scripts behind these accessible require the `GITHUB_API_DISPATCH_TOKEN` variable to be present
in the environment.

These actions use the `xpack-development` branch of this repo and the
[pre-releases/test](https://github.com/xpack-dev-tools/pre-releases/releases/tag/test/)
binaries.

{%- assign platforms_array = platforms | split: "," %}

{%- assign isLinuxArm32 = false %}

{%- for platform in platforms_array %}
{%- if platform == "linux-arm" %}{% assign isLinuxArm32 = true %}{% endif %}
{%- endfor %}

{%- if isLinuxArm32 %}
:::caution

Some of the `docker-linux-arm` tests have an issue on Debian and the
**Clean working area** step fails.

:::
{%- endif %}

The tests results are available from the
[GitHub Actions](https://github.com/{{githubProjectOrganization}}/{{githubProjectName}}/actions) page.

After running the prime tests, download the test results and compare
with previous runs.

{%- if isMacOSX64 %}

#### More macOS tests

Since GitHub Actions provides a limited range of versions for the macOS
runner, the multi-version macOS tests run on Travis.

To trigger the Travis test, run the **trigger-travis-macos** xpm action:

```sh
xpm run trigger-travis-macos -C ~/Work/{{githubProjectOrganization}}/{{githubProjectName}}.git/build-assets
```

This script requires the `TRAVIS_COM_TOKEN` variable to be present
in the environment.

The test results are available from
[Travis CI](https://app.travis-ci.com/github/{{githubProjectOrganization}}/{{githubProjectName}}/builds/).

{%- endif %}

### Manual tests

To download the pre-released archive for the specific platform
and run the tests, use:

```sh
git -C ~/Work/{{githubProjectOrganization}}/{{githubProjectName}}.git pull
xpm run install -C ~/Work/{{githubProjectOrganization}}/{{githubProjectName}}.git/build-assets
xpm run test-pre-release -C ~/Work/{{githubProjectOrganization}}/{{githubProjectName}}.git/build-assets
```

For even more tests, on each platform,
download the archive from
[pre-releases/test](https://github.com/xpack-dev-tools/pre-releases/releases/tag/test/)
and check the binaries.

{%- assign platforms_array = platforms | split: "," %}

{%- assign isMacOS = false %}

{%- for platform in platforms_array %}
{%- if platform == "darwin-x64" or platform == "darwin-arm64" %}{% assign isMacOS = true %}{% endif %}
{%- endfor %}

{%- if isMacOS %}

On macOS, remove the `com.apple.quarantine` flag:

```sh
xattr -cr ${HOME}/Downloads/xpack-*
```

{%- endif %}

<MoreTests/>

## Publish the release

### Create a new GitHub pre-release

- in `CHANGELOG.md`, add the release date and a message
  like _**\* v{{releaseSemver}}-{{releaseSubversion}} released**_
- **commit** with the message _**CHANGELOG update**_
- check and possibly update the `build-assets/templates/body-github-release-liquid.mdx`
- **push** the `xpack-development` branch to GitHub
- run the **trigger-workflow-publish-release** xpm action:
  ```sh
  xpm run trigger-workflow-publish-release -C ~/Work/{{githubProjectOrganization}}/{{githubProjectName}}.git/build-assets
  ```

The workflow result and logs are available from the
[GitHub Actions](https://github.com/{{githubProjectOrganization}}/{{githubProjectName}}/actions) page.

The result is a
[draft pre-release](https://github.com/{{githubProjectOrganization}}/{{githubProjectName}}/releases)
tagged like **v{{releaseSemver}}-{{releaseSubversion}}** (mind the dash in the middle!) and
named like **{{longXpackName}} v{{releaseSemver}}-{{releaseSubversion}}** (mind the dash),
with all binaries attached.

- edit the draft and be sure it is attached to the `xpack-development` branch (important!)
- perform the final edits (maintenance vs. new release) and check if everything is fine
- **keep the pre-release button enabled**
- do **not** enable Discussions yet
- click the **Publish release** button

:::info

At this moment the system should send an email notification to all clients
watching the {{githubProjectName}} project.

:::

### Prepare a new blog post

- check and possibly update the `website/blog/_templates/blog-post-release-part-[12]-liquid.md`
- run the **generate-website-blog-post** xpm action;
this will add a file in the `website/blog` folder:
  ```sh
  xpm run generate-website-blog-post -C ~/Work/{{githubProjectOrganization}}/{{githubProjectName}}.git/build-assets
  ```
- edit the `description` property in the post front matter
- select the correct summary (maintenance vs. new release)
- add entries in the **Bug fixes**; use the following syntax
  ```
  - [[#N](https://github.com/{{githubProjectOrganization}}/{{githubProjectName}}/issues/N)]:
  ```
- copy/paste the folders hierarchies from the install guide
- **commit** with the message _**website: blog post release {{releaseSemver}}-{{releaseSubversion}} published**_

### Update the web install page

- check and possibly update the output of the `--version` runs in
  - `website/docs/install/_project/_automatic-install-quick-test.mdx`
  - `website/docs/install/_project/_manual-install-quick-test.mdx`
- **commit** with the message _**website: update quick tests**_

### Check the list of links in top package.json

- open the top `package.json` file
- check if the links in the `bin` property cover the actual binaries
{%- if packageConfig.permalinkName == "wine" %}
- rename `widl` -> `winewidl`
- remove `function_grep.pl`
{%- endif %}
- if necessary, also check on Windows

### Update the package.json list of binaries

- select the `xpack-development` branch
- be sure that the binaries were attached to the pre-release
- run the **update-package-binaries** xpm action:
  ```sh
  xpm run update-package-binaries -C ~/Work/{{githubProjectOrganization}}/{{githubProjectName}}.git/build-assets
  ```
- open the top `package.json` file
- check the `baseUrl:` it should match the file URLs (including the tag/version);
  no terminating `/` is required
- from the release, check the SHA & file names
- compare the SHA sums with those shown by `cat *.sha`
- check the executable names
- **commit** all changes with the message
  _**package.json: update urls for {{releaseVersion}} release**_

### Publish on the npmjs.com server

- select the `xpack-development` branch
- check the latest commits `xpm run git-log`
- update `CHANGELOG.md`, add a line like _**\* v{{releaseVersion}} published on npmjs.com**_
- **commit** with the message _**CHANGELOG: publish npm v{{releaseVersion}}**_
- `npm pack` and check the content of the archive, which should list
  only the `package.json`, the `README.md`, `LICENSE` and `CHANGELOG.md`;
  possibly adjust `.npmignore`
- configure the version; the first 4 numbers are the same as the
  GitHub release; the fifth number is the npm specific version:
  ```sh
  npm version {{releaseVersion}}
  ```
- the commits and the tag should have been pushed by the `postversion` script;
  if not, push them with `git push origin --tags` to GitHub
- publish and add the `test` tag:
  ```sh
  npm publish --tag test
  ```
- when publishing for the first time, use:
  ```sh
  npm publish --access public
  ```

After a few moments the version will be visible at
<a href="https://www.npmjs.com/package/{{packageScopedName}}?activeTab=versions">npmjs.com</a>.

### Test if the binaries can be installed with xpm

Run the **trigger-workflow-test-xpm** xpm action:

```sh
xpm run trigger-workflow-test-xpm -C ~/Work/{{githubProjectOrganization}}/{{githubProjectName}}.git/build-assets
```

This will install the package via `xpm install` on all supported platforms.

The tests results are available from the
[GitHub Actions](https://github.com/{{githubProjectOrganization}}/{{githubProjectName}}/actions) page.

{%- if packageConfig.showTestsResults == 'true' %}

### Copy the test results

For the toolchain projects, use the **Artifact download URL**
from the **Generate tests report** GitHub Action to
download the `test-report.zip` file, unzip it
and copy the markdown file to `website/docs/tests`.

Edit the `website/docs/tests/index.md` file to add the
new page.

Check the **Known problems** link in the blog post.

Commit with the message _**website: add tests results**_.

{%- endif %}

### Tag the npm package as `latest`

When the release is considered stable, promote it as `latest`:

<CodeBlock language="sh"> {
`npm dist-tag add {{packageScopedName}}@{{releaseVersion}} latest
`} </CodeBlock>

Check the result:

<CodeBlock language="sh"> {
`npm dist-tag ls {{packageScopedName}}
`} </CodeBlock>

In case the release proves problematic and needs to be unpublished:

<CodeBlock language="sh"> {
`npm unpublish {{packageScopedName}}@{{releaseVersion}}
`} </CodeBlock>

### Build the static website locally

Validate the web site content in a local build via the npm `build` script:

```sh
(cd website; npm run build)
```

### Publish the website

- open {{packageHomepage}}docs/maintainer/#publish-the-website in a separate window
- stop the local web server
- select the `website` branch
- **merge** `xpack-development` into `website`
- **push** the `website` branch to GitHub
  :::info
  At this moment an automated GitHub Action will generate and publish the website.
  :::
- if already there from a previous run, delete the <code>web-{dateYYYYMMDD()}</code> tag, including from remote
- add a new tag like <code>web-{dateYYYYMMDD()}</code> and push it to remote
- checkout the `xpack-development` branch
- wait for the publish to complete
- refresh the web page
- the new release blog post is
in {{packageHomepage}}blog/
- remember the post URL, since it must be used to update the release page
and the X/Twitter announcement

The `website` branch may be subsequently updated, as long as the
version in the top `package.json` is not changed.

### Update the `xpack` branch

In this Git repo:

- select the `xpack` branch
- **merge** `xpack-development` into `xpack`
- **push** the `xpack` branch to GitHub
- checkout the `xpack-development` branch

:::note

Avoid further updates to the `xpack` branch until the next release.

:::

### Create the final GitHub release

- go to the [GitHub Releases](https://github.com/{{githubProjectOrganization}}/{{githubProjectName}}/releases) page
- check the download counter, it should match the number of tests
- add a link to the Web blog `[Continue reading »]()`; use an same blog URL
- remove the _tests only_ notice
- **disable** the **Set as a pre-release** button
- **enable** the **Set as the latest release** button
- click the **Update Release** button

### Check SourceForge mirror

- https://sourceforge.net/projects/{{githubProjectName}}/files/

## Cleanups

### Remove the pre-release binaries

- go to https://github.com/{{githubProjectOrganization}}/pre-releases/releases/tag/test/
- remove the test binaries

### Clean the work area

Run the **trigger-workflow-deep-clean** xpm action:

```sh
xpm run trigger-workflow-deep-clean -C ~/Work/{{githubProjectOrganization}}/{{githubProjectName}}.git/build-assets
```

This will remove the build folders on all self-hosted runners.

The results are available from the
[GitHub Actions](https://github.com/{{githubProjectOrganization}}/{{githubProjectName}}/actions) page.

### Close possible open issues

Check GitHub issues and pull requests:

- https://github.com/{{githubProjectOrganization}}/{{githubProjectName}}/issues
- https://github.com/{{githubProjectOrganization}}/{{githubProjectName}}/pulls

Close those that were addressed.

## Share on Twitter

- in a separate browser windows, open [X/Twitter](https://twitter.com)
- using the **`@xpack_project`** account
- paste the release name like _**{{longXpackName}} v{{releaseSemver}}-{{releaseSubversion}} released**_
- paste the link to the blog post
  [release](https://github.com/{{githubProjectOrganization}}/{{githubProjectName}}/releases)
- click the **Tweet** button

<ShareCustom/>

## Analytics

- GitHub [`{{githubProjectOrganization}}/{{githubProjectName}}`](https://github.com/{{githubProjectOrganization}}/{{githubProjectName}}/) repo
  - latest xPack release
[![Github All Releases](https://img.shields.io/github/downloads/{{githubProjectOrganization}}/{{githubProjectName}}/latest/total)](https://github.com/{{githubProjectOrganization}}/{{githubProjectName}}/releases)
  - all xPack releases [![Github All Releases](https://img.shields.io/github/downloads/{{githubProjectOrganization}}/{{githubProjectName}}/total)](https://github.com/{{githubProjectOrganization}}/{{githubProjectName}}/releases){% if packageWebsiteConfig.showDeprecatedGnuMcuAnalytics == 'true' %}
  - previous GNU MCU Eclipse all releases [![Github All Releases](https://img.shields.io/github/downloads/gnu-mcu-eclipse/arm-none-eabi-gcc/total)](https://github.com/gnu-mcu-eclipse/arm-none-eabi-gcc/releases){% endif %}
  - [individual file counters](https://somsubhra.github.io/github-release-stats/?username={{githubProjectOrganization}}&repository={{githubProjectName}}) (grouped by release)
- npmjs.com [`{{packageScopedName}}`](https://www.npmjs.com/package/{{packageScopedName}}/) xPack
  - latest release, per month
[![NPM Version](https://img.shields.io/npm/v/{% if packageScope != "" %}%40{{packageScope}}%2F{% endif %}{{packageName}}?color=green)](https://www.npmjs.com/package/{{packageScopedName}}/)
[![NPM Downloads](https://img.shields.io/npm/dm/{% if packageScope != "" %}%40{{packageScope}}%2F{% endif %}{{packageName}})](https://www.npmjs.com/package/{{packageScopedName}}/)
  - all releases [![NPM Downloads](https://img.shields.io/npm/dt/{% if packageScope != "" %}%40{{packageScope}}%2F{% endif %}{{packageName}})](https://www.npmjs.com/package/{{packageScopedName}}/)

Credit to [Shields IO](https://shields.io) for the badges and to
[Somsubhra/github-release-stats](https://github.com/Somsubhra/github-release-stats)
for the individual file counters.
